<!DOCTYPE html>
<html>
  <head>
  <style>
    /*#demo {
      image-rendering: optimizeSpeed;             /* Older versions of FF          
      image-rendering: -moz-crisp-edges;          /* FF 6.0+                       
      image-rendering: -webkit-optimize-contrast; /* Safari                        
      image-rendering: -o-crisp-edges;            /* OS X & Windows Opera (12.02+) 
      image-rendering: pixelated;                 /* Awesome future-browsers       
    -ms-interpolation-mode: nearest-neighbor;   /* IE                            
    }*/
  </style>
  <script src="https://cdn.rawgit.com/daishihmr/bulletml.js/master/build/bulletml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p2.js/0.7.1/p2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.1/creature.min.js"></script>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.1/custom/phaser-arcade-physics.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.1/custom/phaser-no-physics.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.1/custom/phaser-split.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.1/phaser-creature.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.1/phaser.min.js"></script>
  <script>
    window.addEventListener("keydown", function(e) {
      if([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
          e.preventDefault();
      }
    }, false);
    var danmaku0 = bulletml.buildXML(
      '<bulletml type="vertical" xmlns="http://www.asahi-net.or.jp/~cs8k-cyu/bulletml"><action label="top"> <repeat> <times>10</times> <action> <fire> <direction type="absolute">270</direction> <bulletRef label="bm_seed"> <param>-25</param> </bulletRef> </fire> <wait>20</wait> <fire> <direction type="absolute">90</direction> <bulletRef label="bm_seed"> <param>25</param> </bulletRef> </fire> <wait>25</wait> </action> </repeat></action><bullet label="bm_seed"><speed>24</speed><action> <wait>1</wait> <fire> <bullet> <direction type="absolute">180</direction> <speed>3</speed> <actionRef label="bm"/> </bullet> </fire> <fire> <bullet> <direction type="sequence">$1</direction> <speed>2</speed> <actionRef label="bm"/> </bullet> </fire> <vanish/></action></bullet><action label="bm"> <changeSpeed> <speed>0</speed> <term>50</term> </changeSpeed> <wait>45</wait> <fire> <bulletRef label="round"> <param>1.5</param> <param>0</param> </bulletRef> </fire> <fire> <bulletRef label="round"> <param>1.25</param> <param>7</param> </bulletRef> </fire> <fire> <bulletRef label="round"> <param>1</param> <param>14</param> </bulletRef> </fire> <vanish/></action> <bullet label="round"><speed>0</speed><action> <fire> <direction type="absolute">$2</direction> <speed>$1</speed> <bullet/> </fire> <repeat> <times>10+3*10</times> <action> <fire> <direction type="sequence">360/(10+3*10)</direction> <speed>$1</speed> <bullet/> </fire> </action> </repeat> <vanish/></action></bullet></bulletml>'
    );
    bulletml.dsl();
    var danmaku1 = new bulletml.Root({
      top: action([
        repeat(999, [
          repeat(30, [
            fire(direction(12, "sequence"), speed(5), bullet(actionRef("b"))),
              repeat(9-1, [
                fire(direction(360/9, "sequence"), speed(5), bullet(actionRef("b"))),
              ]),
            wait(2),
          ]),
          wait(30),
          repeat(30, [
            fire(direction(-12, "sequence"), speed(5), bullet(actionRef("b"), {color:"hsl(220, 60%, 80%)"})),
              repeat(9-1, [
                fire(direction(360/9, "sequence"), speed(5), bullet(actionRef("b"), {color:"hsl(220, 60%, 80%)"})),
              ]),
            wait(2),
          ]),
          wait(30),
        ]),
      ]),
      b: action([
        changeSpeed(speed(1), 30),
        wait(30),
        changeDirection(direction(0, "aim"), 60),
        changeSpeed(speed(3), 30),
        wait(50),
        vanish(),
        fire(speed(2), bullet({color:"hsl(50, 60%, 80%)"}))
      ]),
    });

    var SC_W = 300;
    var SC_H = 500;
    window.onload = function() {
      var game = new Phaser.Game(SC_W, SC_H, Phaser.AUTO, '', { preload: preload, create: create, update: update });
      var player, enemyXML, emenyDSL;
      function preload() {
        game.load.image("player", "player.png");
        game.load.image("enemy", "enemy.png");
        game.load.image("bullet1", "bullet1.png");
      }

      function create() {
        player = game.add.sprite(150, 475, "player");
        enemyXML = game.add.sprite(150, 100, "enemy");
        //enemyDSL = game.add.sprite();
        game.physics.arcade.enable(player);
        game.physics.arcade.enable(enemyXML);
        var danmakuConfig = {
          target: player,
          createNewBullet: function(runner, spec) {
            var bullet = Phaser.Bullet(game, runner.x, runner.y, "bullet1");
            runner.onVanish = function() {
                bullet.kill();
            };
            bullet.update = Phaser.Bullet.prototype.update;
          }
        };
        enemyXML.danmakuRunner = danmaku0.createRunner(danmakuConfig);
        enemyXML.update = function(frame) {
          this.x = SC_W/2;//SC_W*.5 - Math.cos(frame*0.01) * SC_W*.4
          this.y = 100;//SC_H*.3 - Math.sin(frame*0.03) * SC_H*.2
          this.danmakuRunner.x = this.x;
          this.danmakuRunner.y = this.y;
          this.danmakuRunner.update();
        };
        /*enemyDSL.danmakuRunner = danmaku1.createRunner(danmakuConfig);
        enemyDSL.update = function(frame) {
          this.x = SC_W*.5 + Math.cos(frame*0.01) * SC_W*.4
          this.y = SC_H*.3 + Math.sin(frame*0.03) * SC_H*.2
          this.danmakuRunner.x = this.x;
          this.danmakuRunner.y = this.y;
          this.danmakuRunner.update();
        };*/
        cursors = this.input.keyboard.createCursorKeys();
        fireButton = this.input.keyboard.addKey(Phaser.KeyCode.Z);
      }

      function update() {
        player.body.velocity.x = 0;
        player.body.velocity.y = 0
        if (cursors.left.isDown) {
          player.body.velocity.x = -200;
        } else if (cursors.right.isDown) {
          player.body.velocity.x = 200;
        }
        if (cursors.up.isDown) {
          player.body.velocity.y = -200;
        } else if (cursors.down.isDown) {
          player.body.velocity.y = 200;
        }
      }
    };
  </script>
  </head>
  <body>
  <canvas id="demo"></canvas>
  </body>
</html>
